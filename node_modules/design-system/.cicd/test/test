#!/usr/bin/env bash

export TRACE=true
source <(curl "${bamboo_cicd_api_url}/v3/")

export APP_NAME="design-system-test"

APP_IMAGE=$(cicd::get_docker_image ${APP_NAME})

CONTAINER_NAME=${APP_NAME}

# Attempt to stop and remove the container but avoid failure
docker stop ${CONTAINER_NAME} || true && docker rm --force ${CONTAINER_NAME} || true

# Build the cypress dockerfile image
docker build --tag ${APP_IMAGE} ${cicd_working_directory}/ -f ${cicd_working_directory}/.cicd/test/Dockerfile

# Run the container
docker run -t -d --name=${CONTAINER_NAME} \
  -e CC_TEST_REPORTER_ID="${CC_TEST_REPORTER_ID}" \
  -e GIT_BRANCH="${bamboo_repository_branch_name}" \
  -e GIT_COMMIT_SHA="${bamboo_repository_revision_number}" \
  -e GIT_COMMITTED_AT="$(git log -1 --pretty=format:%ct)" \
  ${APP_IMAGE}

# Execute unit tests with code coverage
docker exec ${CONTAINER_NAME} /bin/sh -c 'npm run test'

# TODO: Push coverage results to codeclimate, we dont have coverage yet
# docker exec ${CONTAINER_NAME} /bin/sh -c '/usr/bin/cc-test-reporter after-build'

# Attempt to stop and remove the container but avoid failure
docker stop ${CONTAINER_NAME} || true && docker rm --force ${CONTAINER_NAME} || true
