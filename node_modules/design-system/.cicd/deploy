#!/usr/bin/env bash
export TRACE=true

source <(curl "${bamboo_cicd_api_url}/v3/")

export APP_NAME="design-system"
export APP_IMAGE=$(cicd::get_docker_image ${APP_NAME} "-app")
export RELEASE_DIR="semantic-release"

cicd::secrets_export "${APP_NAME}"

export DESIGN_SYSTEM_ASSETS_BUCKET_NAME="${CICD_NAMESPACE}-${APP_NAME}-assets"
export DESIGN_SYSTEM_ASSETS_HOST="https://s3-${CICD_REGION}.amazonaws.com/${DESIGN_SYSTEM_ASSETS_BUCKET_NAME}"

cicd::envsubst_file "${cicd_working_directory}/.cicd/terraform/cicd.tf.dist"
cicd::envsubst_file "${cicd_working_directory}/.cicd/terraform/buckets.tf.dist"

cicd::terraform_apply \
  -auto-approve \
  -var project="${APP_NAME}" \
  -var stack="${CICD_NAMESPACE}" \
  -var cicd_vpc_id="${CICD_VPC_ID}" \
  -var cicd_head_office_cidr="${CICD_HEAD_OFFICE_CIDR}" \
  -var cicd_head_office_reserve_cidr="${CICD_HEAD_OFFICE_RESERVE_CIDR}" \
  -var assets_bucket_name="${DESIGN_SYSTEM_ASSETS_BUCKET_NAME}"

echo "DESIGN_SYSTEM_ASSETS_HOST=${DESIGN_SYSTEM_ASSETS_HOST}
AWS_ACCESS_KEY_ID=${CICD_AWS_KEY}
AWS_SECRET_ACCESS_KEY=${CICD_AWS_PASSWORD}
AWS_DEFAULT_REGION=${CICD_REGION}" > ./.env

# Build for custom HOST
docker run -v ${cicd_working_directory}/dist:/var/www/dist --env-file ./.env "${APP_IMAGE}" /bin/sh -c "HOST=${DESIGN_SYSTEM_ASSETS_HOST}/dist/docs/ npm run build"

# Clean s3 bucket
docker run --rm --env-file ./.env "${APP_IMAGE}" \
  /usr/local/bin/aws s3 rm "s3://${DESIGN_SYSTEM_ASSETS_BUCKET_NAME}/dist" --recursive

# Push build contents
docker run -v ${cicd_working_directory}/dist:/var/www/dist --env-file ./.env "${APP_IMAGE}" \
  /usr/local/bin/aws s3 cp ./dist/ "s3://${DESIGN_SYSTEM_ASSETS_BUCKET_NAME}/dist" --recursive

rm ./.env

# Publish new release tag
docker run \
  -e REPO_URL=${bamboo_planRepository_repositoryUrl} \
  -e BRANCH_NAME=${bamboo_planRepository_branchName} \
  -e GITHUB_TOKEN=${cicd_github_token} \
  -e RELEASE_DIR=${RELEASE_DIR} \
  "${APP_IMAGE}" \
  .cicd/release
