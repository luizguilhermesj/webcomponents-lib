resource "aws_s3_bucket" "DESIGN_SYSTEM_assets" {
  bucket = "${var.assets_bucket_name}"
  acl    = "private"

  tags {
    Project = "${var.project}"
    Stack = "${var.stack}",
    Service = "S3",
  }
}

resource "aws_s3_bucket_policy" "DESIGN_SYSTEM_assets" {
  bucket = "${aws_s3_bucket.DESIGN_SYSTEM_assets.id}"
  policy =<<POLICY
{
  "Version": "2012-10-17",
  "Id": "${var.stack}-${var.project}-assets-policy",
  "Statement": [
      {
          "Sid": "IPAllow",
          "Effect": "Allow",
          "Principal": "*",
          "Action": "s3:GetObject",
          "Resource": "arn:aws:s3:::${var.assets_bucket_name}/*",
          "Condition": {
              "StringEquals": {
                  "aws:sourceVpc": "${var.cicd_vpc_id}"
              }
          }
      },
      {
          "Sid": "IPAllow",
          "Effect": "Allow",
          "Principal": "*",
          "Action": "s3:GetObject",
          "Resource": "arn:aws:s3:::${var.assets_bucket_name}/*",
          "Condition": {
              "IpAddress": {
                  "aws:SourceIp": "${var.cicd_head_office_cidr}"
              }
          }
      }
  ]
}
POLICY
}
